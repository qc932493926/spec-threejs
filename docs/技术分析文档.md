# ğŸ„ 3Dåœ£è¯æ ‘é¡¹ç›®æŠ€æœ¯åˆ†ææ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Reactã€Three.js å’Œ AI æ‰‹åŠ¿è¯†åˆ«çš„é«˜ä¿çœŸ 3D äº¤äº’å¼åœ£è¯æ ‘ Web åº”ç”¨ã€‚é¡¹ç›®å±•ç¤ºäº†ç°ä»£ Web 3D æŠ€æœ¯å’Œ AI è§†è§‰æŠ€æœ¯çš„ç»“åˆåº”ç”¨ã€‚

---

## ä¸€ã€Three.js 3D æ¸²æŸ“æŠ€æœ¯æ ˆ

### 1.1 æ ¸å¿ƒæŠ€æœ¯æ¡†æ¶

#### **React Three Fiber (R3F)**
- **ç‰ˆæœ¬**: `@react-three/fiber@8.17.10`
- **ä½œç”¨**: Three.js çš„ React æ¸²æŸ“å™¨ï¼Œå°† Three.js çš„å‘½ä»¤å¼ API è½¬æ¢ä¸ºå£°æ˜å¼çš„ React ç»„ä»¶
- **æ ¸å¿ƒæ¦‚å¿µ**:
  ```tsx
  import { Canvas, useFrame, extend } from '@react-three/fiber';

  // Canvas æ˜¯ R3F çš„æ ¹ç»„ä»¶ï¼Œè‡ªåŠ¨åˆ›å»º Sceneã€Cameraã€Renderer
  <Canvas dpr={[1, 2]} gl={{ toneMapping: THREE.ReinhardToneMapping }} shadows>
    {/* 3D å†…å®¹ */}
  </Canvas>
  ```

#### **@react-three/drei**
- **ç‰ˆæœ¬**: `@react-three/drei@9.117.0`
- **ä½œç”¨**: R3F çš„è¾…åŠ©å·¥å…·åº“ï¼Œæä¾›å¸¸ç”¨çš„ 3D ç»„ä»¶å’Œ Hooks
- **é¡¹ç›®ä¸­ä½¿ç”¨çš„ç»„ä»¶**:
  - `OrbitControls` - è½¨é“æ§åˆ¶å™¨ï¼Œæ”¯æŒé¼ æ ‡äº¤äº’
  - `Environment` - ç¯å¢ƒå…‰ç…§é¢„è®¾
  - `PerspectiveCamera` - é€è§†ç›¸æœº
  - `Float` - æµ®åŠ¨åŠ¨ç”»æ•ˆæœ
  - `Stars` - æ˜Ÿç©ºèƒŒæ™¯
  - `Sparkles` - é—ªå…‰ç²’å­æ•ˆæœ
  - `useTexture` - çº¹ç†åŠ è½½ Hook
  - `shaderMaterial` - è‡ªå®šä¹‰ç€è‰²å™¨æè´¨

#### **@react-three/postprocessing**
- **ç‰ˆæœ¬**: `@react-three/postprocessing@2.16.3`
- **ä½œç”¨**: åæœŸå¤„ç†æ•ˆæœåº“
- **ä½¿ç”¨æ•ˆæœ**:
  ```tsx
  <EffectComposer>
    <Bloom
      luminanceThreshold={0.8}  // å‘å…‰é˜ˆå€¼
      luminanceSmoothing={0.1}  // å¹³æ»‘åº¦
      intensity={1.5}           // å¼ºåº¦
      radius={0.5}              // åŠå¾„
      mipmapBlur                // Mipmap æ¨¡ç³Š
    />
    <Vignette
      eskil={false}
      offset={0.1}
      darkness={1.2}           // æš—è§’æ•ˆæœ
    />
  </EffectComposer>
  ```

### 1.2 è‡ªå®šä¹‰ç€è‰²å™¨ (Shader Material)

#### **æŠ€æœ¯åŸç†**
ä½¿ç”¨ GLSL (OpenGL Shading Language) ç¼–å†™è‡ªå®šä¹‰æè´¨ï¼Œå®ç°é«˜åº¦å®šåˆ¶åŒ–çš„è§†è§‰æ•ˆæœã€‚

#### **é¡¹ç›®å®ç°**:
```tsx
const FoliageMaterial = shaderMaterial(
  // Uniformsï¼ˆç€è‰²å™¨å…¨å±€å˜é‡ï¼‰
  {
    uTime: 0,                                    // æ—¶é—´
    uColor: new THREE.Color('#004225'),         // é¢œè‰²
    uProgress: 0                                 // åŠ¨ç”»è¿›åº¦
  },

  // Vertex Shaderï¼ˆé¡¶ç‚¹ç€è‰²å™¨ï¼‰
  `uniform float uTime;
   uniform float uProgress;
   attribute vec3 aTargetPos;
   attribute float aRandom;
   varying vec2 vUv;
   varying float vMix;

   // ä¸‰æ¬¡ç¼“åŠ¨å‡½æ•°
   float cubicInOut(float t) {
     return t < 0.5 ? 4.0 * t * t * t : 0.5 * pow(2.0 * t - 2.0, 3.0) + 1.0;
   }

   void main() {
     vUv = uv;
     // æ·»åŠ å™ªå£°åŠ¨ç”»
     vec3 noise = vec3(
       sin(uTime * 1.5 + position.x),
       cos(uTime + position.y),
       sin(uTime * 1.5 + position.z)
     ) * 0.15;

     // åœ¨åˆå§‹ä½ç½®å’Œç›®æ ‡ä½ç½®ä¹‹é—´æ’å€¼
     float t = cubicInOut(uProgress);
     vec3 finalPos = mix(position, aTargetPos + noise, t);

     vec4 mvPosition = modelViewMatrix * vec4(finalPos, 1.0);
     gl_PointSize = (60.0 * (1.0 + aRandom)) / -mvPosition.z;
     gl_Position = projectionMatrix * mvPosition;
     vMix = t;
   }`,

  // Fragment Shaderï¼ˆç‰‡æ®µç€è‰²å™¨ï¼‰
  `uniform vec3 uColor;
   varying float vMix;

   void main() {
     // ç»˜åˆ¶åœ†å½¢ç²’å­
     float r = distance(gl_PointCoord, vec2(0.5));
     if (r > 0.5) discard;

     // é¢œè‰²æ’å€¼
     vec3 finalColor = mix(uColor * 0.3, uColor * 1.2, vMix);
     gl_FragColor = vec4(finalColor, 1.0);
   }`
);
```

**å…³é”®æŠ€æœ¯ç‚¹**:
- `attribute` - æ¯ä¸ªé¡¶ç‚¹ç‹¬ç«‹çš„å±æ€§
- `uniform` - å…¨å±€å…±äº«çš„å˜é‡
- `varying` - ä»é¡¶ç‚¹ç€è‰²å™¨ä¼ é€’åˆ°ç‰‡æ®µç€è‰²å™¨çš„å˜é‡
- `mix()` - GLSL å†…ç½®æ’å€¼å‡½æ•°
- `gl_PointSize` - æ§åˆ¶ç‚¹çš„å¤§å°ï¼ˆå®ç°è¿‘å¤§è¿œå°æ•ˆæœï¼‰
- `gl_PointCoord` - ç‰‡æ®µç€è‰²å™¨ä¸­çš„ç‚¹åæ ‡

### 1.3 ç²’å­ç³»ç»Ÿ

#### **æŠ€æœ¯å®ç°**
ä½¿ç”¨ `BufferGeometry` å’Œ `Points` åˆ›å»ºé«˜æ€§èƒ½ç²’å­ç³»ç»Ÿã€‚

```tsx
// ç”Ÿæˆ 15,000 ä¸ªç²’å­
const count = 15000;
const positions = new Float32Array(count * 3);       // åˆå§‹ä½ç½®
const targetPositions = new Float32Array(count * 3); // ç›®æ ‡ä½ç½®
const randoms = new Float32Array(count);             // éšæœºå€¼

// ä½¿ç”¨ maath åº“ç”Ÿæˆçƒå½¢åˆ†å¸ƒçš„åˆå§‹ä½ç½®
const spherePoints = random.inSphere(
  new Float32Array(count * 3),
  { radius: 25 }
);

// ç”Ÿæˆåœ£è¯æ ‘å½¢çŠ¶çš„ç›®æ ‡ä½ç½®
for (let i = 0; i < count; i++) {
  // åˆå§‹ä½ç½®ï¼ˆçƒå½¢çˆ†ç‚¸æ•ˆæœï¼‰
  positions[i*3] = spherePoints[i*3];
  positions[i*3+1] = spherePoints[i*3+1];
  positions[i*3+2] = spherePoints[i*3+2];

  // ç›®æ ‡ä½ç½®ï¼ˆåœ†é”¥å½¢æ ‘ä½“ï¼‰
  const [tx, ty, tz] = getTreePosition();
  targetPositions[i*3] = tx;
  targetPositions[i*3+1] = ty;
  targetPositions[i*3+2] = tz;

  randoms[i] = Math.random();
}

// åˆ›å»ºå‡ ä½•ä½“
<points>
  <bufferGeometry>
    <bufferAttribute attach="attributes-position" args={[positions, 3]} />
    <bufferAttribute attach="attributes-aTargetPos" args={[targetPositions, 3]} />
    <bufferAttribute attach="attributes-aRandom" args={[randoms, 1]} />
  </bufferGeometry>
  <foliageMaterial ref={materialRef} transparent depthWrite={false} blending={THREE.AdditiveBlending} />
</points>
```

**å…³é”®æŠ€æœ¯**:
- `Float32Array` - ç±»å‹åŒ–æ•°ç»„ï¼Œæ€§èƒ½ä¼˜åŒ–
- `BufferGeometry` - ç›´æ¥æ“ä½œé¡¶ç‚¹æ•°æ®ï¼Œé«˜æ€§èƒ½
- `BufferAttribute` - å®šä¹‰é¡¶ç‚¹å±æ€§
- `AdditiveBlending` - åŠ æ³•æ··åˆæ¨¡å¼ï¼Œå®ç°å‘å…‰æ•ˆæœ

### 1.4 åŠ¨ç”»ç³»ç»Ÿ

#### **useFrame Hook**
R3F æä¾›çš„æ ¸å¿ƒ Hookï¼Œæ¯å¸§æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚

```tsx
useFrame((state, delta) => {
  if (materialRef.current) {
    // æ›´æ–°æ—¶é—´ uniform
    materialRef.current.uTime = state.clock.elapsedTime;

    // å¹³æ»‘æ’å€¼åŠ¨ç”»ï¼ˆé˜»å°¼æ•ˆæœï¼‰
    const targetProgress = state === 'FORMED' ? 1 : 0;
    materialRef.current.uProgress = MathUtils.damp(
      materialRef.current.uProgress,
      targetProgress,
      1.5,    // é˜»å°¼ç³»æ•°
      delta   // æ—¶é—´å¢é‡
    );
  }
});
```

**å‚æ•°è¯´æ˜**:
- `state` - åŒ…å« `clock`ã€`camera`ã€`scene` ç­‰å…¨å±€çŠ¶æ€
- `delta` - è·ç¦»ä¸Šä¸€å¸§çš„æ—¶é—´ï¼ˆç§’ï¼‰

#### **MathUtils.damp()**
Three.js æä¾›çš„é˜»å°¼æ’å€¼å‡½æ•°ï¼Œå®ç°å¹³æ»‘è¿‡æ¸¡ã€‚

```javascript
// å…¬å¼: value += (target - value) * smoothing * delta
MathUtils.damp(current, target, smoothing, deltaTime);
```

### 1.5 å‡ ä½•ä½“å’Œæè´¨

#### **å‡ ä½•ä½“ç±»å‹**
```tsx
// å¹³é¢å‡ ä½•ä½“ï¼ˆç…§ç‰‡è¾¹æ¡†ï¼‰
new THREE.PlaneGeometry(width, height);

// ç›’å­å‡ ä½•ä½“ï¼ˆç¤¼ç‰©ï¼‰
new THREE.BoxGeometry(width, height, depth);

// çƒä½“å‡ ä½•ä½“ï¼ˆå½©ç¯ã€è£…é¥°çƒï¼‰
new THREE.SphereGeometry(radius, widthSegments, heightSegments);

// åœ†æŸ±ä½“å‡ ä½•ä½“ï¼ˆç³–æœæ£’ï¼‰
new THREE.CylinderGeometry(radiusTop, radiusBottom, height, segments);

// æŒ¤å‹å‡ ä½•ä½“ï¼ˆäº”è§’æ˜Ÿï¼‰
new THREE.ExtrudeGeometry(shape, {
  depth: 0.4,
  bevelEnabled: true,
  bevelThickness: 0.1,
  bevelSize: 0.1,
  bevelSegments: 3
});
```

#### **æè´¨ç³»ç»Ÿ**
```tsx
// æ ‡å‡†æè´¨ï¼ˆåŸºäºç‰©ç†çš„æ¸²æŸ“ PBRï¼‰
<meshStandardMaterial
  color="#FFD700"          // åŸºç¡€é¢œè‰²
  map={texture}            // çº¹ç†è´´å›¾
  emissive="#FFD700"       // è‡ªå‘å…‰é¢œè‰²
  emissiveMap={texture}    // è‡ªå‘å…‰è´´å›¾
  emissiveIntensity={1.0}  // è‡ªå‘å…‰å¼ºåº¦
  roughness={0.5}          // ç²—ç³™åº¦ (0-1)
  metalness={0.4}          // é‡‘å±åº¦ (0-1)
  side={THREE.DoubleSide}  // åŒé¢æ¸²æŸ“
  toneMapped={false}       // å…³é—­è‰²è°ƒæ˜ å°„
/>
```

### 1.6 çº¹ç†åŠ è½½ä¸åº”ç”¨

```tsx
// åŠ¨æ€ç”Ÿæˆçº¹ç†è·¯å¾„
const bodyPhotoPaths = [
  '/photos/top.png',
  ...Array.from({ length: 31 }, (_, i) => `/photos/${i + 1}.png`)
];

// ä½¿ç”¨ useTexture Hook æ‰¹é‡åŠ è½½
const textures = useTexture(bodyPhotoPaths);

// åº”ç”¨çº¹ç†
<meshStandardMaterial
  map={textures[index]}
  emissiveMap={textures[index]}
/>
```

### 1.7 å…‰ç…§ç³»ç»Ÿ

```tsx
// ç¯å¢ƒå…‰ï¼ˆå…¨å±€åŸºç¡€ç…§æ˜ï¼‰
<ambientLight intensity={0.4} color="#003311" />

// ç‚¹å…‰æºï¼ˆå±€éƒ¨ç…§æ˜ï¼‰
<pointLight
  position={[30, 30, 30]}
  intensity={100}
  color="#FFD54F"
/>

// ç¯å¢ƒé¢„è®¾ï¼ˆHDR ç¯å¢ƒè´´å›¾ï¼‰
<Environment preset="night" background={false} />
```

### 1.8 ç›¸æœºå’Œæ§åˆ¶

```tsx
// é€è§†ç›¸æœº
<PerspectiveCamera
  makeDefault
  position={[0, 8, 60]}
  fov={45}  // è§†åœºè§’
/>

// è½¨é“æ§åˆ¶å™¨
<OrbitControls
  enablePan={false}         // ç¦ç”¨å¹³ç§»
  enableZoom={true}         // å¯ç”¨ç¼©æ”¾
  minDistance={30}          // æœ€å°è·ç¦»
  maxDistance={120}         // æœ€å¤§è·ç¦»
  autoRotate={true}         // è‡ªåŠ¨æ—‹è½¬
  autoRotateSpeed={0.3}     // æ—‹è½¬é€Ÿåº¦
  maxPolarAngle={Math.PI / 1.7}  // æœ€å¤§æè§’
/>
```

### 1.9 æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

1. **useMemo ç¼“å­˜è®¡ç®—ç»“æœ**
```tsx
const geometry = useMemo(() => new THREE.BoxGeometry(1, 1, 1), []);
```

2. **å®ä¾‹åŒ–å¤ç”¨å‡ ä½•ä½“**
```tsx
const borderGeometry = useMemo(() => new THREE.PlaneGeometry(1.2, 1.5), []);
// å¤šä¸ª mesh å…±äº«åŒä¸€ä¸ª geometry
```

3. **depthWrite ä¼˜åŒ–**
```tsx
<foliageMaterial transparent depthWrite={false} />
```

4. **Suspense æ‡’åŠ è½½**
```tsx
<Suspense fallback={null}>
  <PhotoOrnaments />
</Suspense>
```

---

## äºŒã€æ‘„åƒå¤´ä¸ AI æ‰‹åŠ¿è¯†åˆ«æŠ€æœ¯

### 2.1 æ ¸å¿ƒæŠ€æœ¯æ ˆ

#### **MediaPipe Tasks Vision**
- **ç‰ˆæœ¬**: `@mediapipe/tasks-vision@0.10.22-rc.20250304`
- **å¼€å‘å•†**: Google
- **åŠŸèƒ½**: æä¾›å®æ—¶æ‰‹åŠ¿è¯†åˆ«ã€å§¿æ€æ£€æµ‹ç­‰ AI è§†è§‰åŠŸèƒ½
- **è¿è¡Œæ¨¡å¼**: WebAssembly (WASM) + CPU/GPU

### 2.2 æ‰‹åŠ¿è¯†åˆ«å™¨åˆå§‹åŒ–

```tsx
// 1. åŠ è½½ WASM è¿è¡Œæ—¶
const vision = await FilesetResolver.forVisionTasks(
  "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
);

// 2. åˆ›å»ºæ‰‹åŠ¿è¯†åˆ«å™¨
const recognizer = await GestureRecognizer.createFromOptions(vision, {
  baseOptions: {
    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/gesture_recognizer/gesture_recognizer/float16/1/gesture_recognizer.task",
    delegate: "CPU"  // ä½¿ç”¨ CPU è¿ç®—ï¼ˆå¯é€‰ GPUï¼‰
  },
  runningMode: "VIDEO",              // è§†é¢‘æ¨¡å¼
  numHands: 2,                       // æœ€å¤šæ£€æµ‹ 2 åªæ‰‹
  minHandDetectionConfidence: 0.3,  // æ‰‹éƒ¨æ£€æµ‹ç½®ä¿¡åº¦
  minHandPresenceConfidence: 0.3,   // æ‰‹éƒ¨å­˜åœ¨ç½®ä¿¡åº¦
  minTrackingConfidence: 0.3        // æ‰‹éƒ¨è¿½è¸ªç½®ä¿¡åº¦
});
```

### 2.3 æ‘„åƒå¤´è®¿é—®

#### **getUserMedia API**
```tsx
// è¯·æ±‚æ‘„åƒå¤´æƒé™
const stream = await navigator.mediaDevices.getUserMedia({
  video: {
    width: 640,
    height: 480,
    facingMode: "user"  // å‰ç½®æ‘„åƒå¤´
  }
});

// ç»‘å®šè§†é¢‘æµåˆ° video å…ƒç´ 
if (videoRef.current) {
  videoRef.current.srcObject = stream;

  // ç­‰å¾…è§†é¢‘æ•°æ®åŠ è½½
  videoRef.current.onloadeddata = () => {
    videoRef.current.play().then(() => {
      // å¼€å§‹è¯†åˆ«
      predictWebcam();
    });
  }
}
```

**å…³é”®å±æ€§**:
- `srcObject` - å°† MediaStream ç»‘å®šåˆ° video å…ƒç´ 
- `playsInline` - iOS å†…è”æ’­æ”¾
- `muted` - é™éŸ³ï¼ˆé¿å…å›éŸ³ï¼‰
- `autoPlay` - è‡ªåŠ¨æ’­æ”¾
- `crossOrigin="anonymous"` - è·¨åŸŸæ”¯æŒ

### 2.4 å®æ—¶æ‰‹åŠ¿è¯†åˆ«å¾ªç¯

```tsx
const predictWebcam = () => {
  // æ£€æŸ¥ç»„ä»¶æ˜¯å¦è¿˜åœ¨è¿è¡Œ
  if (!isRunningRef.current) return;

  const video = videoRef.current;
  const recognizer = gestureRecognizerRef.current;

  if (recognizer && video) {
    try {
      // æ£€æŸ¥è§†é¢‘æ˜¯å¦å‡†å¤‡å°±ç»ª
      if (video.readyState >= 2 && video.videoWidth > 0) {
        // å¯¹å½“å‰å¸§è¿›è¡Œè¯†åˆ«
        const results = recognizer.recognizeForVideo(video, Date.now());

        // å¤„ç†è¯†åˆ«ç»“æœ
        if (results.gestures.length > 0) {
          const gesture = results.gestures[0][0];
          const name = gesture.categoryName;  // æ‰‹åŠ¿åç§°
          const score = gesture.score;        // ç½®ä¿¡åº¦

          // ç½®ä¿¡åº¦é˜ˆå€¼è¿‡æ»¤
          if (score > 0.4) {
            if (name === "Open_Palm") onGesture("CHAOS");
            if (name === "Closed_Fist") onGesture("FORMED");
          }

          // æ‰‹éƒ¨ä½ç½®è¿½è¸ªï¼ˆç”¨äºæ—‹è½¬æ§åˆ¶ï¼‰
          if (results.landmarks.length > 0) {
            const landmarks = results.landmarks[0];
            const xPos = landmarks[0].x;  // æ‰‹è…• X åæ ‡ (0-1)
            const speed = (0.5 - xPos) * 0.15;  // è½¬æ¢ä¸ºæ—‹è½¬é€Ÿåº¦
            onMove(Math.abs(speed) > 0.01 ? speed : 0);
          }
        }
      }

      // è¯·æ±‚ä¸‹ä¸€å¸§
      animationFrameId = requestAnimationFrame(predictWebcam);
    } catch (error) {
      console.error('Prediction error:', error);
    }
  }
};
```

**å…³é”®æ–¹æ³•**:
- `recognizeForVideo(video, timestamp)` - è¯†åˆ«è§†é¢‘å¸§
- `results.gestures` - æ£€æµ‹åˆ°çš„æ‰‹åŠ¿åˆ—è¡¨
- `results.landmarks` - æ‰‹éƒ¨å…³é”®ç‚¹åæ ‡ï¼ˆ21ä¸ªç‚¹ï¼‰
- `requestAnimationFrame()` - è¯·æ±‚ä¸‹ä¸€å¸§

### 2.5 æ‰‹åŠ¿è¯†åˆ«ç»“æœç»“æ„

```typescript
interface GestureResult {
  gestures: Array<{
    categoryName: string;    // "Open_Palm", "Closed_Fist", etc.
    score: number;           // ç½®ä¿¡åº¦ (0-1)
    index: number;           // æ‰‹åŠ¿ç´¢å¼•
  }[]>;

  landmarks: Array<{
    x: number;               // X åæ ‡ (0-1)
    y: number;               // Y åæ ‡ (0-1)
    z: number;               // Z åæ ‡ï¼ˆæ·±åº¦ï¼‰
  }[]>;                      // 21 ä¸ªæ‰‹éƒ¨å…³é”®ç‚¹

  worldLandmarks: Array<{
    x: number;               // 3D ç©ºé—´åæ ‡
    y: number;
    z: number;
  }[]>;

  handedness: Array<{
    categoryName: string;    // "Left" or "Right"
    score: number;
  }[]>;
}
```

### 2.6 æ‰‹éƒ¨éª¨éª¼å¯è§†åŒ–

```tsx
const DrawingUtils = new DrawingUtils(ctx);

// ç»˜åˆ¶æ‰‹éƒ¨è¿æ¥çº¿
drawingUtils.drawConnectors(
  landmarks,
  GestureRecognizer.HAND_CONNECTIONS,  // é¢„å®šä¹‰çš„æ‰‹éƒ¨éª¨éª¼è¿æ¥
  {
    color: "#FFD700",
    lineWidth: 2
  }
);

// ç»˜åˆ¶å…³é”®ç‚¹
drawingUtils.drawLandmarks(
  landmarks,
  {
    color: "#FF0000",
    lineWidth: 1
  }
);
```

**æ‰‹éƒ¨å…³é”®ç‚¹ç´¢å¼•**:
```
0: æ‰‹è…•
1-4: æ‹‡æŒ‡
5-8: é£ŸæŒ‡
9-12: ä¸­æŒ‡
13-16: æ— åæŒ‡
17-20: å°æŒ‡
```

### 2.7 ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### **ç»„ä»¶å¸è½½æ¸…ç†**
```tsx
useEffect(() => {
  const isRunningRef = useRef(false);
  isRunningRef.current = true;

  // ... åˆå§‹åŒ–ä»£ç 

  // æ¸…ç†å‡½æ•°
  return () => {
    console.log('Cleaning up AI resources...');
    isRunningRef.current = false;  // åœæ­¢å¾ªç¯

    // å–æ¶ˆåŠ¨ç”»å¸§
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
    }

    // å…³é—­æ‘„åƒå¤´
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }

    // å…³é—­è¯†åˆ«å™¨
    if (gestureRecognizerRef.current) {
      gestureRecognizerRef.current.close();
      gestureRecognizerRef.current = null;
    }
  };
}, []);
```

**å…³é”®æŠ€æœ¯**:
- `useRef` - é¿å…é—­åŒ…é™·é˜±ï¼Œè·å–æœ€æ–°çŠ¶æ€
- `cancelAnimationFrame()` - åœæ­¢åŠ¨ç”»å¾ªç¯
- `track.stop()` - é‡Šæ”¾æ‘„åƒå¤´èµ„æº
- `recognizer.close()` - é‡Šæ”¾ AI æ¨¡å‹èµ„æº

### 2.8 Debug æ¨¡å¼å®ç°

```tsx
// è§†é¢‘é¢„è§ˆ
<video
  ref={videoRef}
  style={{
    opacity: debugMode ? 0.6 : 0,        // æ§åˆ¶å¯è§æ€§
    position: 'fixed',
    top: 0,
    right: 0,
    width: debugMode ? '320px' : '0px',
    zIndex: debugMode ? 100 : -1,        // æ§åˆ¶å±‚çº§
    transform: 'scaleX(-1)'              // é•œåƒç¿»è½¬
  }}
/>

// éª¨éª¼ç»˜åˆ¶ç”»å¸ƒ
<canvas
  ref={canvasRef}
  style={{
    position: 'fixed',
    top: 0,
    right: 0,
    width: debugMode ? '320px' : '0px',
    zIndex: debugMode ? 101 : -1,        // åœ¨è§†é¢‘ä¸Šå±‚
    transform: 'scaleX(-1)'
  }}
/>
```

---

## ä¸‰ã€æ‰‹åŠ¿äº¤äº’æ˜ å°„

### 3.1 æ‰‹åŠ¿ä¸åœºæ™¯çŠ¶æ€

| æ‰‹åŠ¿ | MediaPipe è¯†åˆ«åç§° | è§¦å‘åŠ¨ä½œ | åœºæ™¯çŠ¶æ€ |
|------|-------------------|----------|----------|
| ğŸ– å¼ å¼€æ‰‹æŒ | `Open_Palm` | æ•£å¼€ | `CHAOS` |
| âœŠ æ¡ç´§æ‹³å¤´ | `Closed_Fist` | èšåˆ | `FORMED` |

### 3.2 æ‰‹éƒ¨ä½ç½®ä¸è§†è§’æ—‹è½¬

```tsx
// X åæ ‡æ˜ å°„åˆ°æ—‹è½¬é€Ÿåº¦
const xPos = landmarks[0].x;  // æ‰‹è…• X åæ ‡ (0-1)
const speed = (0.5 - xPos) * 0.15;

// speed < 0: å‘å·¦æ—‹è½¬
// speed > 0: å‘å³æ—‹è½¬
// speed â‰ˆ 0: åœæ­¢æ—‹è½¬

onMove(Math.abs(speed) > 0.01 ? speed : 0);
```

### 3.3 OrbitControls åŠ¨æ€æ§åˆ¶

```tsx
const controlsRef = useRef();

useFrame(() => {
  if (controlsRef.current) {
    // æ ¹æ®æ‰‹åŠ¿é€Ÿåº¦æ›´æ–°æ–¹ä½è§’
    controlsRef.current.setAzimuthalAngle(
      controlsRef.current.getAzimuthalAngle() + rotationSpeed
    );
    controlsRef.current.update();
  }
});
```

---

## å››ã€æ•°å­¦å·¥å…·åº“ (Maath)

### 4.1 random.inSphere

```tsx
import * as random from 'maath/random';

// ç”Ÿæˆçƒå½¢åˆ†å¸ƒçš„éšæœºç‚¹
const spherePoints = random.inSphere(
  new Float32Array(count * 3),
  { radius: 25 }
);
```

**ç”¨é€”**: ç”Ÿæˆç²’å­çš„åˆå§‹"çˆ†ç‚¸"ä½ç½®

---

## äº”ã€é¡¹ç›®æ¶æ„æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          React åº”ç”¨å±‚ (App.tsx)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Canvas (R3F)   â”‚  â”‚ GestureController â”‚  â”‚
â”‚  â”‚  - Experience  â”‚  â”‚  - MediaPipe      â”‚  â”‚
â”‚  â”‚  - Foliage     â”‚  â”‚  - getUserMedia   â”‚  â”‚
â”‚  â”‚  - Ornaments   â”‚  â”‚  - Video/Canvas   â”‚  â”‚
â”‚  â”‚  - Lights      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  - Effects     â”‚           â–²             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚             â”‚
â”‚         â”‚                     â”‚             â”‚
â”‚         â–¼                     â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚       çŠ¶æ€ç®¡ç† (useState)           â”‚    â”‚
â”‚  â”‚  - sceneState: 'CHAOS' | 'FORMED'  â”‚    â”‚
â”‚  â”‚  - rotationSpeed: number           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
         â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Three.js å±‚     â”‚  â”‚  Web APIs            â”‚
â”‚  - Scene         â”‚  â”‚  - MediaStream       â”‚
â”‚  - Renderer      â”‚  â”‚  - Canvas 2D         â”‚
â”‚  - Geometry      â”‚  â”‚  - RequestAF         â”‚
â”‚  - Material      â”‚  â”‚  - WebAssembly       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€å…³é”®é…ç½®å‚æ•°

### 6.1 è§†è§‰é…ç½®
```typescript
const CONFIG = {
  counts: {
    foliage: 15000,    // æ ‘å¶ç²’å­æ•°é‡
    ornaments: 300,    // ç…§ç‰‡æ•°é‡
    elements: 200,     // åœ£è¯è£…é¥°æ•°é‡
    lights: 400        // å½©ç¯æ•°é‡
  },
  tree: {
    height: 22,        // æ ‘é«˜
    radius: 9          // åº•éƒ¨åŠå¾„
  }
};
```

### 6.2 æ€§èƒ½æŒ‡æ ‡
- **ç²’å­æ€»æ•°**: ~15,400 ä¸ª
- **ç½‘æ ¼å¯¹è±¡**: ~900 ä¸ª
- **çº¹ç†æ•°é‡**: 32 å¼ 
- **å¸§ç‡ç›®æ ‡**: 60 FPS
- **åˆ†è¾¨ç‡**: æ”¯æŒ 1x-2x è®¾å¤‡åƒç´ æ¯”

---

## ä¸ƒã€æµè§ˆå™¨å…¼å®¹æ€§

### 7.1 å¿…éœ€ç‰¹æ€§
- âœ… WebGL 2.0
- âœ… WebAssembly
- âœ… MediaStream API
- âœ… ES2020+

### 7.2 æ¨èæµè§ˆå™¨
- Chrome 90+
- Edge 90+
- Firefox 88+
- Safari 14.1+ (éƒ¨åˆ†åŠŸèƒ½å—é™)

---

## å…«ã€ä¾èµ–æ¸…å•

```json
{
  "dependencies": {
    "@mediapipe/tasks-vision": "^0.10.22-rc.20250304",
    "@react-three/drei": "^9.117.0",
    "@react-three/fiber": "^8.17.10",
    "@react-three/postprocessing": "^2.16.3",
    "maath": "^0.10.8",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "three": "^0.169.0"
  }
}
```

---

## ä¹ã€å­¦ä¹ èµ„æº

### Three.js ç›¸å…³
- [Three.js å®˜æ–¹æ–‡æ¡£](https://threejs.org/docs/)
- [React Three Fiber æ–‡æ¡£](https://docs.pmnd.rs/react-three-fiber)
- [Drei ç»„ä»¶åº“](https://github.com/pmndrs/drei)
- [Three.js Journey è¯¾ç¨‹](https://threejs-journey.com/)

### MediaPipe ç›¸å…³
- [MediaPipe å®˜æ–¹æ–‡æ¡£](https://developers.google.com/mediapipe)
- [Hand Gesture Recognition Guide](https://developers.google.com/mediapipe/solutions/vision/gesture_recognizer)
- [MediaPipe Tasks Vision API](https://developers.google.com/mediapipe/api/solutions/js/tasks-vision)

### WebGL/GLSL ç›¸å…³
- [The Book of Shaders](https://thebookofshaders.com/)
- [WebGL Fundamentals](https://webglfundamentals.org/)
- [Shadertoy](https://www.shadertoy.com/)

---

## åã€æ‰©å±•å¼€å‘å»ºè®®

### 10.1 æ€§èƒ½ä¼˜åŒ–æ–¹å‘
1. å®ç° LOD (Level of Detail) ç³»ç»Ÿ
2. ä½¿ç”¨ InstancedMesh æ‰¹é‡æ¸²æŸ“é‡å¤å¯¹è±¡
3. å®ç°è§†é”¥å‰”é™¤ (Frustum Culling)
4. ä½¿ç”¨ Web Worker å¤„ç†æ‰‹åŠ¿è¯†åˆ«

### 10.2 åŠŸèƒ½æ‰©å±•å»ºè®®
1. æ·»åŠ æ›´å¤šæ‰‹åŠ¿ï¼ˆæã€æ—‹è½¬ã€ç¼©æ”¾ï¼‰
2. æ”¯æŒå¤šäººåŒæ—¶äº¤äº’
3. æ·»åŠ å£°éŸ³æ•ˆæœ
4. å®ç°ç…§ç‰‡ä¸Šä¼ åŠŸèƒ½
5. æ·»åŠ åˆ†äº«/å¯¼å‡ºåŠŸèƒ½

### 10.3 AI å¢å¼ºå»ºè®®
1. é›†æˆå§¿æ€æ£€æµ‹ï¼ˆå…¨èº«äº¤äº’ï¼‰
2. å®ç°äººè„¸è¿½è¸ªï¼ˆè‡ªåŠ¨å¯¹ç„¦ï¼‰
3. æ·»åŠ ç‰©ä½“æ£€æµ‹ï¼ˆAR æ•ˆæœï¼‰
4. å®ç°æ·±åº¦ä¼°è®¡ï¼ˆé®æŒ¡å…³ç³»ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ç”Ÿæˆæ—¥æœŸ**: 2026-02-05
**é¡¹ç›®ç‰ˆæœ¬**: christmas-tree@0.0.0
